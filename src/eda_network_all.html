<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Network graph</title>
    <link
        rel="stylesheet"
        href="https://stackpath.bootstrapcdn.com/bootstrap/4.1.3/css/bootstrap.min.css"
        integrity="sha384-MCw98/SFnGE8fJT3GXwEOngsV7Zt27NXFoaoApmYm81iuXoPkFOJwJ8ERdknLPMO"
        crossorigin="anonymous"
    />
    <style>
        .slider{
            display: grid;
            grid-template-columns: 1fr 1fr;
            grid-gap: 20px;
            width: 1000px;
            position: absolute;
            top: 30px;
            left: 30px;
        }
        .sliderContainer{
            display: grid;
            width: 500px;
            height: 200px;
            grid-template-rows: 55px 1fr;
            font-size: 13px;
        }
    </style>
</head>
<body>


<canvas id="network" width="800" height="800"></canvas>
<div class="slider">
    <div class="sliderContainer">
        <p>Ingredient frequency threshold</p>
        <div id="nodeSlider"></div>
    </div>
    <div class="sliderContainer">
        <p>Ingredient-pair coappearance threshold</p>
        <div id="linkSlider"></div>
    </div>
</div>

<script src="https://d3js.org/d3.v4.min.js"></script>
<script src="https://unpkg.com/d3-simple-slider"></script>

<script>
/* global d3 */

var canvas = d3.select("#network"),
    width = canvas.attr("width"),
    height = canvas.attr("height"),
    ctx = canvas.node().getContext("2d"),
    color = d3.scaleOrdinal(d3.schemeCategory20),
    simulation = d3.forceSimulation()
        // attracts nodes to the center of the svg area
        .force("center", d3.forceCenter(width / 2, height / 2))
        // adds repulsion between nodes
        .force("charge", d3.forceManyBody().strength(-100))
        // provides links between nodes
        .force("link", d3.forceLink().id( d => d.ingd ));

var nodeThresDefault=200, linkThresDefault=20,
    nodeThresVal = nodeThresDefault,
    linkThresVal = linkThresDefault;

d3.json("https://gist.githubusercontent.com/longyyu/11dde8de4a0517ac7a4039d08436742b/raw/05f28c575a8dc77ad23ca6d3c27d04fc4dd461fc/recipenlg-network.json", function (err, data) {
    if (err) throw err;

    simulation.nodes(data.nodes);
    simulation.force("link").links(data.links);
    simulation.on("tick", update);

    var nodeSlider = d3.sliderBottom()
        .min(0)
        .max(Math.max(...data.nodes.map(d => d.freq)))
        .width(200)
        .ticks(5)
        .default(nodeThresDefault)
        .on('onchange', val => {
            nodeThresVal = val;
            update();
        })
    d3.select('#nodeSlider')
        .append('svg')
        .append('g')
        .attr('transform', 'translate(10, 10)')
            .call(nodeSlider);

    var linkSlider = d3.sliderBottom()
        .min(0)
        .max(Math.max(...data.links.map(d => d.count)))
        .width(200)
        .ticks(5)
        .default(linkThresDefault)
        .on('onchange', val => {
            linkThresVal = val;
            update();
        })
    d3.select('#linkSlider')
        .append('svg')
        .append('g')
        .attr('transform', 'translate(10, 10)')
            .call(linkSlider);

    canvas
        .call(d3.drag()
            .container(canvas.node())
            .subject( // find dragged subject
                () => simulation.find(d3.event.x, d3.event.y)
            )
            .on("start", () => { // drag started
                if (!d3.event.active) simulation.alphaTarget(0.3).restart();
                d3.event.subject.fx = d3.event.subject.x;
                d3.event.subject.fy = d3.event.subject.y;
            })
            .on("drag", () => { // dragged
                d3.event.subject.fx = d3.event.x;
                d3.event.subject.fy = d3.event.y;
            })
            .on("end", () => { // drag ended
                if (!d3.event.active) simulation.alphaTarget(0);
                d3.event.subject.fx = null;
                d3.event.subject.fy = null;
            }));

    function update() {
        ctx.clearRect(0, 0, width, height);

        ctx.beginPath();
        ctx.globalAlpha = 0.2;
        ctx.strokeStyle = "#aaa";
        data.links.filter(l => l.count > linkThresVal).forEach((l) => { // draws links
            ctx.moveTo(l.source.x, l.source.y);
            ctx.lineTo(l.target.x, l.target.y);
        });
        ctx.stroke();

        ctx.font = '12px sans-serif';  
        data.nodes.filter(d => d.freq > nodeThresVal).forEach((d) => { // draw nodes
            ctx.beginPath();
            ctx.fillStyle = color(d.party); // update!
            ctx.moveTo(d.x, d.y);
            ctx.arc(d.x, d.y, 2 + d.freq / 50, 0, Math.PI*2);
            ctx.globalAlpha = .45;
            ctx.fill();
            ctx.globalAlpha = .95;
            ctx.fillText(d.ingd, d.x, d.y);
        });
    }

});

</script>

</body>
</html>
